name: Patent Search Batch Processing

on:
  schedule:
    # 15åˆ†ã”ã¨ã«å®Ÿè¡Œ
    - cron: '*/15 * * * *'  # æ¯Žæ™‚0åˆ†ã€15åˆ†ã€30åˆ†ã€45åˆ†ã«å®Ÿè¡Œ
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œç”¨
    inputs:
      dry_run:
        description: 'Dry run mode (ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ)'
        required: false
        default: false
        type: boolean

jobs:
  batch-process:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current time in JST
        id: time
        run: |
          echo "jst_time=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_OUTPUT
          echo "hour=$(TZ=Asia/Tokyo date '+%H')" >> $GITHUB_OUTPUT

      - name: Determine priority level
        id: priority
        run: |
          # 15åˆ†ã”ã¨ã®å®Ÿè¡Œã§ã¯ã€åˆ†å˜ä½ã§å„ªå…ˆåº¦ã‚’æ±ºå®š
          MINUTE=$(TZ=Asia/Tokyo date '+%-M')
          if [ "$MINUTE" = "0" ]; then
            echo "level=high" >> $GITHUB_OUTPUT
            echo "priority=8-10" >> $GITHUB_OUTPUT
          elif [ "$MINUTE" = "15" ]; then
            echo "level=medium" >> $GITHUB_OUTPUT
            echo "priority=4-7" >> $GITHUB_OUTPUT
          elif [ "$MINUTE" = "30" ]; then
            echo "level=low" >> $GITHUB_OUTPUT
            echo "priority=0-3" >> $GITHUB_OUTPUT
          else
            echo "level=mixed" >> $GITHUB_OUTPUT
            echo "priority=0-10" >> $GITHUB_OUTPUT
          fi

      - name: Show execution info
        run: |
          echo "ðŸ• Execution time: ${{ steps.time.outputs.jst_time }}"
          echo "ðŸ“Š Priority level: ${{ steps.priority.outputs.level }} (${{ steps.priority.outputs.priority }})"
          echo "ðŸ”— Target URL: https://ip-rich-poc-phase1.vercel.app"
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "âš ï¸ DRY RUN MODE - No actual API call will be made"
          fi

      - name: Trigger cron endpoint
        if: github.event.inputs.dry_run != 'true'
        id: cron_call
        run: |
          response=$(curl -s -w "\n%{http_code}" -X GET \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET_KEY }}" \
            -u "${{ secrets.BASIC_AUTH_USERNAME }}:${{ secrets.BASIC_AUTH_PASSWORD }}" \
            https://ip-rich-poc-phase1.vercel.app/api/cron/check-and-do)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"
          echo "Response body: $body"

          if [ "$http_code" != "200" ]; then
            echo "âŒ Cron endpoint returned error status: $http_code"
            exit 1
          fi

          echo "âœ… Cron job triggered successfully"
          echo "response_body=$body" >> $GITHUB_OUTPUT

      - name: Parse response
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸ“Š Cron execution results:"
          echo "${{ steps.cron_call.outputs.response_body }}" | jq '.' || echo "${{ steps.cron_call.outputs.response_body }}"

      - name: Send notification on failure
        if: failure() && github.event.inputs.dry_run != 'true'
        run: |
          echo "âŒ Patent search batch processing failed at ${{ steps.time.outputs.jst_time }}"
          # TODO: Slack/Discordé€šçŸ¥ã‚’è¿½åŠ 

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Patent Search Batch Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: ${{ steps.time.outputs.jst_time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Priority**: ${{ steps.priority.outputs.level }} (${{ steps.priority.outputs.priority }})" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "- **Mode**: DRY RUN (ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Mode**: PRODUCTION" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY